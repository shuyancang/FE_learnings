<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    // 说一下Oauth2.0登录详细流程

    /*
      1. Oauth2.0 是一种允许第三方应用使用资源所有者凭据获得对资源有限访问权限的一种授权协议。
        微信登录豆瓣, 知乎等，相当于微信允许豆瓣作为第三方应用在经过微信授权后, 通过微信办法的授权凭证有限的访问用户的微信头像，手机号性别等受限制资源，从而构建自身登录的逻辑
        第三方应用程序获取的凭证并不等同于资源拥有者持有用户的用户名和密码, 一般访问凭证是标识一个特定范围，生命周期和访问权限的一个字符串访问令牌(token)；
        Oauth2.0协议通过引入一个授权层来讲第三方应用程序与资源拥有者进行分离即所谓：auth认证服务/sso单点登录

        1.1 假定现有某微信用户通过微信登录豆瓣网: 
          1) resource owner资源拥有者
            有权授予对保护资源访问权限的实体: 最终用户 ==> 微信用户
          2) resource server资源服务器
            承载受保护资源的服务器, 能够接收到使用访问令牌对受保护资源的请求并相应，与授权服务器可以是同一服务器，也可是不同服务器。==> 微信服务器
          3) client客户端
            代表资源所有者及其授权发出对受保护资源请求的应用程序 ==> 豆瓣
          4) authorization server授权服务器
            认证服务器, 即服务提供商专门用来处理认证授权的服务器。==> 微信开放平台提供的认证服务的服务器
          
        1.2 Oauth2协议流程: 
          1) 微信用户在豆瓣网上点击微信授权登录
          2) 豆瓣网返回微信用户授权地址
          3) 用户浏览器重定向至微信开放平台用户授权地址(展示微信用户授权二维码或qq用户密码输入框)
          4) 用户授权(微信扫描二维码qq用户名密码) 实现authorization Grant
          5) 微信开放平台验证用户身份, 生成临时凭证code
          6) 携带临时凭证code重定向到第三步中的豆瓣网设定的重定向地址, 重定向
          7) 通过临时凭证换取access_token, 生成授权码access_token并管理
          8) 返回access_token授权信息
          9) 通过access_token访问资源接口, 获取昵称，头像，性别等
          10) 完成用户注册逻辑, 生成用户会话信息, 完成第三方授权登录

          以上流程中, 关键在于用户怎样给Client授权, 只有授权了才能获得访问令牌(accesstoken)。
          关于如何授权, Oauth2中定义了四种授权方式, 木签微信登录使用的是常用的authorizationcode模式
      2. Oauth2.0 客户端授权模式
        2.1 授权码模式(authoriation code)
          功能最完整流程最严密的授权模式
          通过客户端后台服务器与服务提供商的认证服务互动，这种模式下授权代码不是客户端直接从资源所有者获取，而是通过授权服务器作为中介获取，授权认证过程也是自愿所有者直接通过授权服务器进行身份认证，避免资源所有者身份凭证与客户端共享的可能，因此十分安全。
          例如，微信用户授权登录豆瓣网的过程中，微信授权认证是直接在微信的网站上进行的，即便是输入用户名密码也只有微信授权认证服务器可以获取，因此豆瓣网是感知不到的，从而避免了微信用户账号信息在第三方网站泄露的风险。
        2.2 简化模式(implicit)
          对授权码模式的简化, 不通过客户端引用程序的服务器, 而是在浏览器中直接向认证服务器申请令牌，跳过"临时凭证"步骤, 其所有步骤都在浏览器中完成, 令牌对访问者可见且客户端不需要认证。
        2.3 密码模式(resource owner password credentials)
          用户需要向客户端提供自己的用户名和密码，使用这些信息向服务提供商索要授权，
          相当于在豆瓣网中使用微信登录，我们需要在豆瓣网输入微信的用户名和密码，然后由豆瓣网使用我们的微信用户名和密码去向微信服务器获取授权信息
          一般用在用户对客户端高度信任情况下。虽然协议规定客户端不可存储用户密码但无法强制约束，安全性低，一般不考虑使用该模式。
        2.3 客户端模式(client credentials)
          客户端以自己的名义，而不是以用户的名义想服务提供商进行认证，严格说客户端模式不属于oauth2.0协议所要解决的问题。这种模式下用户不需要对客户端授权，直接向客户端注册，客户端以自己的名义要求服务提供商提供服务
          这种类似于之前共享单车比较火的情况下，出现的全能车的模式，即用户向全能车注册，全能车以自己平台设立的共享账户去开各种品牌的单车。
      
      3. 单点登录
        基本原理: 引导未登录用户到认证系统登录 => 用户登录, 获取凭证-令牌 => 再次访问引用, 并携带令牌作为凭证 => 应用内根据用户令牌检验, 如果通过即可访问其他信任业务服务器
        3.1 用户访问系统1受保护资源, 未登录叫转到sso认证中心, 并将自己地址作为参数
        3.2 sso认证中心发现用户未登录, 引导到登录页面
        3.3 用户提交, 登录
        3.4 用户信息认证后, 创建用户与sso认证中心间的会话, 称为全局会话同时创建授权令牌
        3.5 sso携带令牌跳转回最初请求地址(系统1)
        3.6 系统1携带令牌, 在sso认证中心检查令牌是否有效
        3.7 sso认证中心检查令牌有效后, 注册系统1(返回cookie)
        3.8 系统1使用该令牌创建与用户的会话，成为局部会话，返回受保护的资源
        3.9 用户访问系统2, 
        3.10 系统2发现用户未登录, 跳转至sso, 并将自己的地址作为参数
        3.11 sso认证中心发现用户已经登录, 跳转回系统2地址, 并附带令牌
        3.12 系统2携带令牌到sso验证是否有效, 注册系统2
        3.13 系统2使用令牌创建与用户的局部会话资源
        3.14. 用户登录成功后, 会与sso认证中心及各子系统建立会话, 用户与sso的会话称为全局会话, 与各个子系统的会话称为局部会话。局部会话建立后, 用户访问子系统受保护的资源不在通过sso。

      4. 单点登录的销毁流程
        4.1 用户向系统提交注销操作
        4.2 系统根据用户与系统创建的当前会话拿到令牌并向sso认证中心提交注销操作
        4.3 sso认证中心检查令牌是否有效, 销毁全局会话, 同事取出所有用此令牌注册的系统地址
        4.4 sso认证中心向所有注册系统发起注销请求, 各注册系统销毁局部会话
        4.5 sso认证中心引导用户回到登录页面
    */
  </script>
</body>
</html>